(function(f,p){typeof exports=="object"&&typeof module<"u"?p(exports):typeof define=="function"&&define.amd?define(["exports"],p):(f=typeof globalThis<"u"?globalThis:f||self,p(f.Dong={}))})(this,function(f){"use strict";function p(e,t,...o){return console.log("createElement生成的原始虚拟DOM如下"),e==null&&console.error("ERROR"),console.log({type:e,props:{...t,children:o.map(n=>typeof n=="object"?n:g(n))}}),{type:e,props:{...t,children:o.map(n=>typeof n=="object"?n:g(n))}}}function g(e){return{type:"TEXT_ELEMENT",props:{nodeValue:e,children:[]}}}let a=null,u=null,h=null,E=[],c=null,d=0;function D(e,t){u={dom:t,props:{children:[e]},alternate:h},a=u,console.log("render阶段结束,生成的wipRoot如下"),console.log(u)}requestIdleCallback(m);function m(e){let t=!1;for(;a&&!t;)a=N(a),t=e.timeRemaining()<1,t&&console.warn("空闲时间耗尽，生成虚拟 DOM 被打断，等待下次调度以便从上次中断的地方继续");!a&&u&&W(),a&&requestIdleCallback(m)}function N(e){if(c=e,typeof e.type=="function"&&(d=0,e.hooks=[]),R(e),e.child)return e.child;let t=e;for(;t;){if(t.sibling)return t.sibling;t=t.return}return null}function R(e){var t;if(typeof e.type=="function"){const o=e.type(e.props);Array.isArray(o)?T(e,o):T(e,[o])}else{e.dom||(e.dom=_(e));const o=((t=e.props)==null?void 0:t.children)||[];T(e,o)}}function V(e,t){if(e===t)return!0;const o=Object.keys(e),n=Object.keys(t);if(o.length!==n.length)return!1;for(let l of o){const s=e[l],r=t[l];if(l==="children"){if(Array.isArray(s)&&Array.isArray(r)){if(s.length!==r.length)return!1;if(s.length>1){for(let i=0;i<s.length;i++)if(s[i].type!==r[i].type)return!1}else if(s.length===1&&(Array.isArray(s[0])&&console.error(s[0]),!Array.isArray(s[0])))return s[0].props.nodeValue===r[0].props.nodeValue}}else{if(l.startsWith("on")&&typeof s=="function"&&typeof r=="function")return s===r;if(!w(s,r))return!1}}return!0}const w=(e,t)=>{if(e===t)return!0;if(typeof e!="object"||typeof t!="object"||e==null||t==null)return!1;const o=Object.keys(e),n=Object.keys(t);if(o.length!==n.length)return!1;for(let l of o)if(!n.includes(l)||!w(e[l],t[l]))return!1;return!0};function I(e,t){return e===t?!0:e.type!==t.type?!1:V(e.props,t.props)}function T(e,t){let o=0,n=null,l=e.alternate&&e.alternate.child,s=t.flat();for(;o<s.length||l!=null;){let r=s[o];typeof r!="object"&&(r=g(r));let i=null;l&&r&&r.type===l.type?!I(r,l)?(console.warn("节点与上一课fiber树不一致,需要进行节点更新,更新的fiber如下"),i={type:l.type,props:r.props,dom:l.dom,return:e,alternate:l,effectTag:"UPDATE"},alert("节点与上一课fiber树不一致,需要进行节点更新："+JSON.stringify(i.props)),console.log(i),console.log(l)):i={type:l.type,props:r.props,dom:l.dom,return:e,alternate:l,effectTag:""}:(r&&(i={type:r.type,props:r.props,dom:null,return:e,alternate:null,effectTag:"PLACEMENT"}),l&&(l.effectTag="DELETION",E.push(l))),l&&(l=l.sibling),o===0?e.child=i:n&&(n.sibling=i),console.log("协调后的虚拟DOM如下"),n=i,console.log(n),o++}}function W(){E.forEach(y),E=[],y(u.child),k(u.child),h=u,u=null}function k(e){e&&(e.hooks&&e.hooks.forEach(t=>{t.effect&&t.hasEffect&&(t.cleanup=t.effect(),t.hasEffect=!1)}),k(e.child),k(e.sibling))}function y(e){if(!e)return;let t=e.return;for(;!t.dom;)t=t.return;const o=t.dom;if(e.effectTag==="PLACEMENT"&&e.dom!=null)o.appendChild(e.dom),console.log("节点插入");else if(e.effectTag==="UPDATE"&&e.dom!=null)B(e.dom,e.alternate.props,e.props);else if(e.effectTag==="DELETION"){O(e,o),console.log("节点删除");return}y(e.child),y(e.sibling)}function O(e,t){e&&(e.dom?t.removeChild(e.dom):O(e.child,t),O(e.sibling,t))}function _(e){let t;e.type=="TEXT_ELEMENT"?t=document.createTextNode(e.props.nodeValue):t=document.createElement(e.type==null?"div":e.type);for(const o in e.props)H(t,o,e.props[o]);return console.log("真实DOM如下:"),console.log(t),t}function A(e,t){return typeof t=="function"&&e.startsWith("on")}function U(e,t){return e=="style"&&typeof t=="object"}function C(e,t){return typeof t!="object"&&typeof t!="function"}const H=(e,t,o)=>{if(t!=="children")if(t==="nodeValue")e.textContent=o;else if(A(t,o)){const n=t.slice(2).toLowerCase();e.addEventListener(n,o)}else U(t,o)?Object.assign(e.style,o):C(t,o)&&e.setAttribute(t,o)};function B(e,t,o){if(e instanceof Text){t.nodeValue!==o.nodeValue&&(e.nodeValue=o.nodeValue);return}Object.entries(t).filter(([n,l])=>A(n,l)).forEach(([n,l])=>{const s=n.toLowerCase().substring(2);e.removeEventListener(s,l)}),Object.entries(o).filter(([n,l])=>A(n,l)).forEach(([n,l])=>{const s=n.toLowerCase().substring(2);e.addEventListener(s,l)}),Object.keys(t).filter(n=>C(n,t[n])).forEach(n=>{n in o||e.removeAttribute(n)}),Object.keys(o).filter(n=>C(n,o[n])).forEach(n=>{t[n]!==o[n]&&e.setAttribute(n,o[n])}),t.style&&Object.keys(t.style).forEach(n=>{(!o.style||!(n in o.style))&&(e.style[n]="")}),o.style&&Object.keys(o.style).forEach(n=>{(!t.style||t.style[n]!==o.style[n])&&(e.style[n]=o.style[n])})}function L(e){const t=c.alternate&&c.alternate.hooks?c.alternate.hooks[d]:null,o={state:t?t.state:e,queue:t?t.queue:[]};o.queue.forEach(l=>{console.log("处理hooks中"),console.log("action",l),o.state=l(o.state)}),o.queue.length=0;const n=l=>{console.log("setState调用"),o.queue.push(typeof l=="function"?l:()=>l),u={dom:h.dom,props:h.props,alternate:h},a=u,console.log("调用useState造成重新渲染"),requestIdleCallback(m)};return c.hooks.push(o),d++,[o.state,n]}function j(e,t){const o=c.alternate&&c.alternate.hooks?c.alternate.hooks[d]:null;let n;o&&t?n=t.some((s,r)=>!Object.is(s,o.deps[r])):n=!0;const l={deps:t,effect:e,cleanup:o?o.cleanup:null};if(n){l.cleanup&&l.cleanup();const s=e();l.cleanup=typeof s=="function"?s:null}c.hooks.push(l),d++}function S(e,t){const o=c.alternate&&c.alternate.hooks?c.alternate.hooks[d]:null;let n;o&&t?n=t.some((s,r)=>!Object.is(s,o.deps[r])):n=!0;const l={callback:n?e:o.callback,deps:t};return c.hooks.push(l),d++,l.callback}function q(){const e=new Set;function t(o,n){if(o==="dom"||o==="alternate")return"[忽略]";if(o==="props"&&typeof n=="object"&&n!==null){const l={};return Object.keys(n).forEach(s=>{(s==="children"||typeof n[s]!="function")&&(l[s]=n[s])}),l}if(typeof n=="object"&&n!==null){if(e.has(n))return"[循环引用]";e.add(n)}return n}return[JSON.stringify(u,t,2),u]}const M={createElement:p,render:D,useState:L,useEffect:j,useAware:q,useCallBack:S};typeof window<"u"&&(window.Dong=M),f.default=M,f.render=D,f.useAware=q,f.useCallBack=S,f.useEffect=j,f.useState=L,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
